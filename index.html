<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <meta name="description" content="üìÉ A custom webpage, powered by URL query parameters" />
  <meta name="keywords" content="" />
  <meta name="author" content="Leo Herzog | herzog.tech" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.css" />
  <title>Parameter Page ‚Äî A custom webpage, powered by URL query parameters</title>
</head>
<body>
  <main class="container">
    <div>
      <article style="max-width:900px;margin:auto;">
        <header>
          <h1 id="title" style="margin-bottom:0"></h1>
        </header>
        <section id="content">
          <p><img id="image" style="width:100%;" /></p>
          <p id="description"></p>
          <p><a id="link" target="_blank"></a></p>
        </section>
        <section id="input" style="display:none">
          <input id="new-title" type="text" placeholder="Title" />
          <input id="new-image" type="text" placeholder="Optional Image URL" />
          <textarea id="new-description" placeholder="Content"></textarea>
          <div class="grid">
            <input id="new-link" type="text" placeholder="Link" />
            <input id="new-link-text" type="text" placeholder="Link Button Text" />
          </div>
          <p><small>‚ÑπÔ∏è Nothing is sent to a server or saved</small></p>
        </section>
        <section id="output" style="display:none">
          <h4>Your Link</h4>
          <input id="result" type="text" readonly />
          <div class="grid">
            <button id="copy">üìã Copy to Clipboard</button>
            <a id="open" target="_blank"><button>‚ÜóÔ∏è Open in New Window</button></a>
          </div>
        </section>
        <p style="float:right;font-size:.75em;"><a href="https://herzog.tech/" target="_blank">üíô</a></p>
      </article>
    </div>
    
  </main>
  <footer id="faq" class="container">
    <details>
      <summary>Why does this page say this?</summary>
      <p>
        The content on this page lives entirely in the web address.
        The person who sent you here wrote what's on this page.
        Anybody can create and share one of these links.
        This is a simple way to create small webpages without needing to host anything yourself.
      </p>
      <span id="reset" role="button">‚Æ™ Make Your Own</button>
    </details>
  </footer>
  <script>
    var title = document.getElementById('new-title');
    var image = document.getElementById('new-image');
    var description = document.getElementById('new-description');
    var link = document.getElementById('new-link');
    var linktext = document.getElementById('new-link-text');
    var input = document.getElementById('input');
    var output = document.getElementById('output');
    var faq = document.getElementById('faq');
    var result = document.getElementById('result');
    var copy = document.getElementById('copy');
    var open = document.getElementById('open');

    document.addEventListener('DOMContentLoaded', e => {

      title.addEventListener('change', e => update());
      title.addEventListener('keyup', e => update());
      var imagechange;
      image.addEventListener('change', e => {
        clearTimeout(imagechange);
        imagechange = setTimeout(() => update(), 400);
      });
      image.addEventListener('keyup', e => {
        clearTimeout(imagechange);
        imagechange = setTimeout(() => update(), 400);
      });
      description.addEventListener('change', e => update());
      description.addEventListener('keyup', e => update());
      link.addEventListener('change', e => update());
      link.addEventListener('keyup', e => update());
      linktext.addEventListener('change', e => update());
      linktext.addEventListener('keyup', e => update());
      copy.addEventListener('click', e => {
        result.select();
        document.execCommand('copy');
      });
      document.getElementById('reset').addEventListener('click', e => reset());

      // check for params on first load
      const params = new Proxy(new URLSearchParams(window.location.search), {
        "get": (searchParams, prop) => searchParams.get(prop),
      });
      if (params.title || params.description || params.link) {
        title.value = params.title;
        image.value = params.image;
        description.value = params.description;
        link.value = params.link;
        linktext.value = params.linktext;
        show();
      } else {
        reset();
      }

    });

    function reset() {
      title.value = '';
      image.value = '';
      description.value = '';
      link.value = '';
      linktext.value = '';
      window.history.replaceState(null, document.title, window.location.pathname);
      document.getElementById('title').innerText = 'What would you like your page to say?';
      document.getElementById('description').innerText = '';
      document.getElementById('content').style.display = 'none';
      update();
      input.style.display = 'block';
      output.style.display = 'none';
      faq.style.display = 'none';
    }

    function show() {
      document.getElementById('title').innerText = title.value;
      document.getElementById('image').src = image.value;
      document.getElementById('description').innerText = description.value;
      document.getElementById('link').innerHTML = link.value ? '<button>' + linktext.value + '</button>' : '';
      document.getElementById('link').href = link.value;
      document.getElementById('content').style.display = 'block';
      input.style.display = 'none';
      output.style.display = 'none';
      faq.style.display = 'block';
    }

    async function update() {
      if (title.value || description.value || link.value) {
        if (image.value) { // check if image url is valid
          try {
            console.log('Checking ' + image.value + '...');
            const res = await fetch(image.value); // even follows redirects. amazing.
            const buff = await res.blob();
            if (buff.type.startsWith('image/')) {
              image.setAttribute('aria-invalid', 'false');
            } else {
              image.setAttribute('aria-invalid', 'true');
            }
          }
          catch (e) { // invalid url, also catches CORS errors
            image.setAttribute('aria-invalid', 'true');
          }
        } else { // no url
          image.setAttribute('aria-invalid', '');
        }
        if (link.value) {
          let valid = /^((https?|mailto):\/\/)?[a-z0-9-\.]+\.[a-z]/.test(link.value);
          link.setAttribute('aria-invalid', !valid);
        } else { // no url
          link.setAttribute('aria-invalid', '');
        }
        result.value = window.location.origin + '/?';
        let values = {"title": title.value, "image": image.value, "description": description.value, "link": link.value, "linktext": linktext.value};
        for (let [param, value] of Object.entries(values)) {
          if (value) result.value += `${param}=${encodeURIComponent(value.trim().escapeHtml().replace(/\n/g, '<br>'))}&`;
        }
        result.value = result.value.slice(0, -1);
        open.href = result.value;
        output.style.display = 'block';
      } else {
        output.style.display = 'none';
      }
    }

    String.prototype.escapeHtml = function() {
      return this.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&apos;');
    }
  </script>
</body>
</html>