<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <meta name="description" content="üìÉ A custom webpage, powered by URL query parameters" />
  <meta name="keywords" content="landing page, confirmation page, homepage, custom, hosting, dynamic, static site" />
  <meta name="author" content="Leo Herzog | herzog.tech" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" />
  <title>Parameter Page ‚Äî A custom webpage, powered by URL query parameters</title>
  <style>
  p:empty, p > img[src=""] {
    display: none;
  }
  </style>
</head>
<body>

  <main class="container">
    <div>
      <article style="max-width:900px;margin:auto;">
        <header class="headings">
          <h1 id="title" style="margin-bottom:0"></h1>
          <a id="example" href="/?title=This%20is%20an%20Example%20Page&image=https%3A%2F%2Flive.staticflickr.com%2F65535%2F52259221868_e86daccb7d_6k.jpg&alt=An%20undulating%2C%20translucent%20star-forming%20region%20in%20the%20Carina%20Nebula%20is%20shown%20in%20this%20Webb%20image%2C%20hued%20in%20ambers%20and%20blues%3B%20foreground%20stars%20with%20diffraction%20spikes%20can%20be%20seen%2C%20as%20can%20a%20speckling%20of%20background%20points%20of%20light%20through%20the%20cloudy%20nebula&description=Anything%20that%20you%20want%20to%20say%20will%20be%20encoded%20into%20the%20link%20itself%20for%20you%20to%20share%20with%20anybody.&link=%2F&linktext=Make%20Your%20Own!">See an Example</a>
        </header>
        <section id="content">
          <p><img id="image" style="width:100%;" /></p>
          <p id="description"></p>
          <p><a id="link" target="_blank"></a></p>
        </section>
        <section id="input" style="display:none">
          <input id="new-title" type="text" placeholder="Title" />
          <textarea id="new-description" placeholder="Content"></textarea>
          <fieldset>
            <label for="image-toggle">
              <input type="checkbox" id="image-toggle" role="switch">
              Include Image
            </label>
            <label for="link-toggle">
              <input type="checkbox" id="link-toggle" role="switch">
              Include Button Link
            </label>
          </fieldset>
          <div id="new-image-group" class="grid" style="display:none">
            <input id="new-image" type="text" placeholder="Image URL" />
            <textarea id="new-image-alt" type="text" placeholder="Description of the Image"></textarea>
          </div>
          <div id="new-link-group" class="grid" style="display:none">
            <input id="new-link" type="text" placeholder="Link" />
            <input id="new-link-text" type="text" placeholder="Link Button Text" />
          </div>
          <p><small>‚ÑπÔ∏è Nothing is sent to a server or saved</small></p>
        </section>
        <section id="output" style="display:none">
          <h4>Your Link</h4>
          <input id="result" type="text" readonly />
          <div class="grid">
            <button id="copy">üìã Copy to Clipboard</button>
            <a id="open" target="_blank"><button>‚ÜóÔ∏è Open in New Window</button></a>
          </div>
        </section>
        <p style="float:right"><small><a href="https://herzog.tech/" target="_blank">üíô</a></small></p>
      </article>
    </div>
  </main>

  <footer id="faq" class="container">
    <details>
      <summary>Why does this page say this?</summary>
      <p>
        The content on this page lives entirely in the web address.
        The person who sent you here wrote what's on this page.
        Anybody can create and share one of these links.
        This is a simple way to create small webpages without needing to host anything yourself.
      </p>
      <span id="reset" role="button">‚Æ™ Make Your Own</span>
    </details>
  </footer>
  
  <script>
    var title = document.getElementById('new-title');
    var description = document.getElementById('new-description');
    var image = document.getElementById('new-image');
    var alt = document.getElementById('new-image-alt');
    var link = document.getElementById('new-link');
    var linktext = document.getElementById('new-link-text');
    var input = document.getElementById('input');
    var example = document.getElementById('example');
    var output = document.getElementById('output');
    var faq = document.getElementById('faq');
    var result = document.getElementById('result');
    var copy = document.getElementById('copy');
    var open = document.getElementById('open');

    document.addEventListener('DOMContentLoaded', e => {

      title.addEventListener('change', e => update());
      title.addEventListener('keyup', e => update());
      description.addEventListener('change', e => update());
      description.addEventListener('keyup', e => update());
      document.getElementById('image-toggle').addEventListener('change', e => {
        document.getElementById('new-image-group').style.display = e.target.checked ? 'grid' : 'none';
      });
      document.getElementById('link-toggle').addEventListener('change', e => {
        document.getElementById('new-link-group').style.display = e.target.checked ? 'grid' : 'none';
      });
      var imagechange;
      image.addEventListener('change', e => {
        clearTimeout(imagechange);
        imagechange = setTimeout(() => update(), 400);
      });
      image.addEventListener('keyup', e => {
        clearTimeout(imagechange);
        imagechange = setTimeout(() => update(), 400);
      });
      link.addEventListener('change', e => update());
      link.addEventListener('keyup', e => update());
      linktext.addEventListener('change', e => update());
      linktext.addEventListener('keyup', e => update());
      copy.addEventListener('click', e => {
        result.select();
        document.execCommand('copy');
      });
      document.getElementById('reset').addEventListener('click', e => reset());

      // check for params on first load
      const params = new Proxy(new URLSearchParams(window.location.search), {
        "get": (searchParams, prop) => searchParams.get(prop),
      });
      if (params.title || params.description) {
        title.value = params.title;
        description.value = params.description;
        image.value = params.image;
        alt.value = params.alt;
        link.value = params.link;
        linktext.value = params.linktext;
        show();
      } else {
        reset();
      }

    });

    function reset() {
      title.value = '';
      description.value = '';
      image.value = '';
      alt.value = '';
      link.value = '';
      linktext.value = '';
      window.history.replaceState(null, document.title, window.location.pathname);
      document.getElementById('title').innerText = 'What would you like your page to say?';
      document.getElementById('description').innerText = 'Create your custom ' + location.host + (window.location.pathname === '/' ? '' : window.location.pathname) + ' webpage';
      document.getElementById('description').innerText = 'Blah';
      document.getElementById('content').style.display = 'none';
      update();
      example.style.display = 'show';
      input.style.display = 'block';
      output.style.display = 'none';
      faq.style.display = 'none';
    }

    function show() {
      document.getElementById('title').innerHTML = title.value;
      document.getElementById('description').innerHTML = description.value;
      document.getElementById('image').src = image.value;
      document.getElementById('image').alt = alt.value;
      document.getElementById('link').innerHTML = link.value ? '<button>' + (linktext.value ? linktext.value : link.value) + '</button>' : '';
      document.getElementById('link').href = link.value;
      document.getElementById('content').style.display = 'block';
      example.style.display = 'none';
      input.style.display = 'none';
      output.style.display = 'none';
      faq.style.display = 'block';
    }

    async function update() {
      if (title.value || description.value) {
        example.style.display = 'none';
        if (!image.value) {
          image.setAttribute('aria-invalid', '');
        } else {
          try {
            console.log('Checking ' + image.value + '...');
            const res = await fetch(image.value); // even follows redirects. amazing.
            const buff = await res.blob();
            image.setAttribute('aria-invalid', !buff.type.startsWith('image/'));
          }
          catch (e) { // invalid url, also catches CORS errors
            image.setAttribute('aria-invalid', 'true');
          }
        }
        if (!link.value) {
          link.setAttribute('aria-invalid', '');
        } else {
          let valid = /^((https?|mailto):\/\/)?[a-z0-9-\.]+\.[a-z]/.test(link.value);
          link.setAttribute('aria-invalid', !valid);
        }
        result.value = window.location.origin + '/?';
        let values = {"title": title.value, "image": image.value, "alt": alt.value, "description": description.value, "link": link.value, "linktext": linktext.value};
        for (let [param, value] of Object.entries(values)) {
          if (value) result.value += `${param}=${encodeURIComponent(value.trim().escapeHtml().replace(/\n/g, '<br>'))}&`;
        }
        result.value = result.value.slice(0, -1);
        open.href = result.value;
        example.style.display = 'none';
        output.style.display = 'block';
      } else {
        example.style.display = 'block';
        output.style.display = 'none';
      }
    }

    String.prototype.escapeHtml = function() {
      return this.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&apos;');
    }
  </script>
</body>
</html>